# Water Quality Parser API v2

API –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞–Ω–Ω—ã—Ö –æ –∫–∞—á–µ—Å—Ç–≤–µ –≤–æ–¥—ã –∏–∑ PDF-—Ñ–∞–π–ª–æ–≤ –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º GigaChat.

## –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- üìÑ –û–±—Ä–∞–±–æ—Ç–∫–∞ PDF –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å —Ç–∞–±–ª–∏—Ü–∞–º–∏
- ü§ñ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ GigaChat Pro
- üìä –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ 26 —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è–º –∫–∞—á–µ—Å—Ç–≤–∞ –≤–æ–¥—ã
- üéØ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ 7 —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Å—Ç–æ–ª–±—Ü–æ–≤ –¥–∞–Ω–Ω—ã—Ö
- üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–≤—Ç–æ—Ä—ã –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- ‚úÇÔ∏è –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –æ–±—Ä–µ–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- üîç –ì–∏–±–∫–∏–π –ø–æ–∏—Å–∫ –Ω–∞–∑–≤–∞–Ω–∏–π –≤–µ—â–µ—Å—Ç–≤ –∏ —Å—Ç–æ–ª–±—Ü–æ–≤

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Python 3.8+
- GigaChat API credentials

### –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

```bash
pip install fastapi uvicorn httpx pydantic python-dotenv pillow pymupdf
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env`:

```env
GIGACHAT_CLIENT_ID=your_client_id
GIGACHAT_CLIENT_SECRET=your_client_secret
GIGACHAT_AUTH_KEY=your_base64_auth_key
```

### –ó–∞–ø—É—Å–∫

```bash
python main.py
```

API –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ `http://localhost:8082`

## API Endpoints

### 1. –ü–∞—Ä—Å–∏–Ω–≥ —Ç–∞–±–ª–∏—Ü—ã –∫–∞—á–µ—Å—Ç–≤–∞ –≤–æ–¥—ã

**POST** `/api/v1/parse/water`

–û—Å–Ω–æ–≤–Ω–æ–π endpoint –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ç–∞–±–ª–∏—Ü.

#### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –¢–∏–ø | –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|-----|--------------|----------|
| `file` | File | ‚úÖ | PDF –∏–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å —Ç–∞–±–ª–∏—Ü–µ–π |
| `materials` | String | ‚ùå | –°–ø–∏—Å–æ–∫ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é –∏–ª–∏ JSON) |
| `column` | String | ‚ùå | –ö–æ–¥ —Å—Ç–æ–ª–±—Ü–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: `fk_fp`) |
| `crop_left_half` | Boolean | ‚ùå | –û–±—Ä–µ–∑–∞—Ç—å –ª–µ–≤—É—é –ø–æ–ª–æ–≤–∏–Ω—É (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: `true`) |
| `max_retries` | Integer | ‚ùå | –ú–∞–∫—Å–∏–º—É–º –ø–æ–ø—ã—Ç–æ–∫ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: `2`) |

#### –î–æ—Å—Ç—É–ø–Ω—ã–µ —Å—Ç–æ–ª–±—Ü—ã

| –ö–æ–¥ | –ù–∞–∑–≤–∞–Ω–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----|----------|----------|
| `fk_fp` | –§–ö (–§–ü) | –§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è |
| `dk_star` | –î–ö* | –î–æ–ø—É—Å—Ç–∏–º–∞—è –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è (–Ω–æ—Ä–º–∞—Ç–∏–≤ 1) |
| `fk_dk_star` | –§–ö/–î–ö* | –û—Ç–Ω–æ—à–µ–Ω–∏–µ –§–ö –∫ –î–ö* |
| `dk_double_star` | –î–ö** | –î–æ–ø—É—Å—Ç–∏–º–∞—è –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è (–Ω–æ—Ä–º–∞—Ç–∏–≤ 2) |
| `fk_dk_double_star` | –§–ö/–î–ö** | –û—Ç–Ω–æ—à–µ–Ω–∏–µ –§–ö –∫ –î–ö** |
| `fk_decl` | –§–ö–¥–µ–∫–ª | –î–µ–∫–ª–∞—Ä–∏—Ä—É–µ–º–∞—è –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è |
| `fk_fk_decl` | –§–ö/–§–ö–¥–µ–∫–ª | –û—Ç–Ω–æ—à–µ–Ω–∏–µ –§–ö –∫ –§–ö–¥–µ–∫–ª |

#### –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã

–ê–∑–æ—Ç –æ–±—â–∏–π, –ê–ª—é–º–∏–Ω–∏–π, –ë–ü–ö 5, –í–æ–¥–æ—Ä–æ–¥–Ω—ã–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å, –í–∑–≤–µ—à–µ–Ω–Ω—ã–µ –≤–µ—â–µ—Å—Ç–≤–∞, –ñ–µ–ª–µ–∑–æ, –ñ–∏—Ä—ã, –ö–∞–¥–º–∏–π, –ú–∞—Ä–≥–∞–Ω–µ—Ü, –ú–µ–¥—å, –ù–µ—Ñ—Ç–µ–ø—Ä–æ–¥—É–∫—Ç—ã, –ù–∏–∫–µ–ª—å, –°–≤–∏–Ω–µ—Ü, –°–ü–ê–í (–∞–Ω–∏–æ–Ω–Ω—ã–µ), –°–ü–ê–í (–Ω–µ–∏–æ–Ω–æ–≥–µ–Ω–Ω—ã–µ), –§–µ–Ω–æ–ª—ã, –§–æ—Å—Ñ–æ—Ä –æ–±—â–∏–π, –•–ü–ö, –•–ü–ö/–ë–ü–ö5, –¶–∏–Ω–∫, –°—É–ª—å—Ñ–∞—Ç—ã, –•–ª–æ—Ä–∏–¥—ã, –ê–º–º–æ–Ω–∏–π-–∏–æ–Ω, –ù–∏—Ç—Ä–∏—Ç—ã, –ù–∏—Ç—Ä–∞—Ç—ã, –§–æ—Å—Ñ–∞—Ç—ã

#### –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤

**–ë–∞–∑–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å (–≤—Å–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã)**

```bash
curl -X POST "http://localhost:8082/api/v1/parse/water" \
  -F "file=@water_report.pdf" \
  -F "column=fk_fp"
```

**–° —É–∫–∞–∑–∞–Ω–∏–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤**

```bash
curl -X POST "http://localhost:8082/api/v1/parse/water" \
  -F "file=@water_report.pdf" \
  -F "materials=–ê–ª—é–º–∏–Ω–∏–π,–ñ–µ–ª–µ–∑–æ,–ë–ü–ö 5" \
  -F "column=fk_dk_star"
```

**JSON —Å–ø–∏—Å–æ–∫ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤**

```bash
curl -X POST "http://localhost:8082/api/v1/parse/water" \
  -F "file=@table.jpg" \
  -F 'materials=["–ê–∑–æ—Ç –æ–±—â–∏–π","–§–æ—Å—Ñ–æ—Ä –æ–±—â–∏–π","–•–ü–ö"]' \
  -F "column=fk_fp"
```

**–ë–µ–∑ –æ–±—Ä–µ–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è**

```bash
curl -X POST "http://localhost:8082/api/v1/parse/water" \
  -F "file=@full_table.png" \
  -F "column=fk_fp" \
  -F "crop_left_half=false"
```

#### –û—Ç–≤–µ—Ç

```json
{
  "status": "success",
  "file_type": "pdf",
  "column": "fk_fp",
  "column_name": "–§–ö (–§–ü)",
  "materials_requested": 3,
  "materials_found": 2,
  "values": {
    "–ê–ª—é–º–∏–Ω–∏–π": 0.15,
    "–ñ–µ–ª–µ–∑–æ": 0.38,
    "–ë–ü–ö 5": null
  },
  "metadata": {
    "cropped": true,
    "attempts_made": 1,
    "extracted_at": "2025-01-15T10:30:00",
    "filtered": true
  }
}
```

### 2. –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ç–æ–ª–±—Ü–∞—Ö

**GET** `/api/v1/info/columns`

–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å—Ç–æ–ª–±—Ü–æ–≤ —Å –∏—Ö –æ–ø–∏—Å–∞–Ω–∏—è–º–∏.

```bash
curl "http://localhost:8082/api/v1/info/columns"
```

### 3. –°–ø–∏—Å–æ–∫ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤

**GET** `/api/v1/info/materials`

–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤.

```bash
curl "http://localhost:8082/api/v1/info/materials"
```

### 4. –ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º

**POST** `/api/v1/image/upload_and_prompt`

–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∫ GigaChat.

#### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã

- `file` (File) - –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
- `prompt` (String) - —Ç–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞

```bash
curl -X POST "http://localhost:8082/api/v1/image/upload_and_prompt" \
  -F "file=@document.jpg" \
  -F "prompt=–û–ø–∏—à–∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —ç—Ç–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞"
```

## –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç—ã

### –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤

- **PDF**: –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å –≤—ã—Å–æ–∫–∏–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ–º (3x zoom)
- **–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è**: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –≤ RGB —Ñ–æ—Ä–º–∞—Ç
- **–û–±—Ä–µ–∑–∫–∞**: –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –æ–±—Ä–µ–∑–∞–µ—Ç—Å—è –ª–µ–≤–∞—è –ø–æ–ª–æ–≤–∏–Ω–∞ (–¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –ª–∏—à–Ω–∏—Ö –¥–∞–Ω–Ω—ã—Ö)

### –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç GigaChat Pro —Å —Ñ—É–Ω–∫—Ü–∏—è–º–∏ –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –≤—ã–≤–æ–¥–∞
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≥–∏–±–∫–æ–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏–π (—Å —É—á–µ—Ç–æ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞, –ø—Ä–æ–±–µ–ª–æ–≤, —Å–∫–æ–±–æ–∫)
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã —á–∏—Å–µ–ª (–∑–∞–ø—è—Ç–∞—è/—Ç–æ—á–∫–∞ –∫–∞–∫ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç –∑–∞–ø—Ä–æ—Å –ø—Ä–∏ –Ω–µ—É–¥–∞—á–µ (–¥–æ `max_retries` —Ä–∞–∑)

### –¢–æ–∫–µ–Ω-–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç

- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ access token
- –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è
- Thread-safe —Ä–∞–±–æ—Ç–∞ —Å —Ç–æ–∫–µ–Ω–∞–º–∏ —á–µ—Ä–µ–∑ asyncio.Lock

## –ö–æ–¥—ã –æ—à–∏–±–æ–∫

| –ö–æ–¥ | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----|----------|
| `TOKEN_ERROR` | –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ –¥–æ—Å—Ç—É–ø–∞ |
| `GENERATION_ERROR` | –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ–ø–∏—Å–∞–Ω–∏—è |
| `FILE_ERROR` | –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–∞ |
| `PARSE_ERROR` | –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Ç–∞–±–ª–∏—Ü—ã |
| `INVALID_REQUEST` | –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å |

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ Python

```python
import requests

# –ë–∞–∑–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
with open('water_report.pdf', 'rb') as f:
    response = requests.post(
        'http://localhost:8082/api/v1/parse/water',
        files={'file': f},
        data={'column': 'fk_fp'}
    )
    
print(response.json())

# –° —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
with open('table.jpg', 'rb') as f:
    response = requests.post(
        'http://localhost:8082/api/v1/parse/water',
        files={'file': f},
        data={
            'column': 'fk_dk_star',
            'materials': '–ñ–µ–ª–µ–∑–æ,–ú–µ–¥—å,–¶–∏–Ω–∫',
            'crop_left_half': 'true'
        }
    )
    
data = response.json()
print(f"–ù–∞–π–¥–µ–Ω–æ: {data['materials_found']}/{data['materials_requested']}")
print(f"–ó–Ω–∞—á–µ–Ω–∏—è: {data['values']}")
```

## –õ–∏—Ü–µ–Ω–∑–∏—è

MIT

## –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–î–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤ –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ issue –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞.
